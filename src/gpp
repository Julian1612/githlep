#!/bin/bash
source "$HOME/.local/bin/git-suite-lib.sh"
! git rev-parse --is-inside-work-tree >/dev/null 2>&1 && exit 1
CB=$(git branch --show-current)
ui_header "PUSH & PR" "$CB"
printf "${CYAN}Pushing...${RESET} "
if out=$(git push 2>&1); then
    printf "${GREEN}✔ Done${RESET}\n"
else
    if [[ "$out" == *"upstream"* ]]; then
        printf "${YELLOW}⚠ No upstream.${RESET}\n"
        printf "Set upstream? [Y/n] "; read -r y
        [[ "$y" =~ ^[Yy]?$ ]] && git push -u origin "$CB" && printf "${GREEN}✔ Done${RESET}\n" || exit 1
    else
        printf "\n${RED}Failed:${RESET}\n$out\n"; exit 1
    fi
fi
U=$(git config remote.origin.url)
[[ "$U" == git@* ]] && U=${U//:/\/} && U=${U//git@/https:\/\/}; U=${U%.git}
L=""
[[ "$U" == *github* ]] && L="$U/compare/$CB?expand=1"
[[ "$U" == *gitlab* ]] && L="$U/-/merge_requests/new?merge_request[source_branch]=$CB"
if [ -n "$L" ]; then
    printf "\n${GREEN}Open PR? [Y/n]${RESET} "; read -rsn1 k
    [[ "$k" =~ ^[Yy]?$ ]] && (open "$L" || wslview "$L" || xdg-open "$L") 2>/dev/null
fi
printf "\n"