#!/bin/bash
source "$HOME/.local/bin/git-suite-lib.sh"

# --- TEMPLATES ---

get_makefile_content() {
    cat <<EOF
NAME	= $1
SRC_DIR = src
OBJ_DIR = obj
INC_DIR = includes

SRC		= \$(wildcard \$(SRC_DIR)/*.$2)
OBJ		= \$(patsubst \$(SRC_DIR)/%.$2, \$(OBJ_DIR)/%.o, \$(SRC))

CC		= $3
CFLAGS	= -Wall -Wextra -Werror $4 -I\$(INC_DIR)

all: \$(NAME)

\$(NAME): \$(OBJ)
	@echo "Linking \$(NAME)..."
	@\$(CC) \$(OBJ) -o \$(NAME)

\$(OBJ_DIR)/%.o: \$(SRC_DIR)/%.$2 | \$(OBJ_DIR)
	@\$(CC) \$(CFLAGS) -c $< -o \$@

\$(OBJ_DIR):
	@mkdir -p \$(OBJ_DIR)

clean:
	@rm -rf \$(OBJ_DIR)

fclean: clean
	@rm -f \$(NAME)

re: fclean all

.PHONY: all clean fclean re
EOF
}

get_cpp_header() {
    local name="$1"
    local upper=$(echo "$name" | tr '[:lower:]' '[:upper:]')
    cat <<EOF
#ifndef ${upper}_H
#define ${upper}_H

class $name {
public:
    $name();
    ~$name();
    $name(const $name &other);
    $name& operator=(const $name &other);

private:

};

#endif
EOF
}

get_cpp_source() {
    local name="$1"
    cat <<EOF
#include "../includes/$name.h"
#include <iostream>

$name::$name() {
}

$name::~$name() {
}

$name::$name(const $name &other) {
    *this = other;
}

$name& $name::operator=(const $name &other) {
    if (this != &other) {
        // Copy logic
    }
    return *this;
}
EOF
}

# --- ACTIONS ---

fetch_joke() {
    # Versucht, einen Witz zu laden (Timeout 1s), Fallback auf Hello World
    if command -v curl >/dev/null 2>&1; then
        JOKE=$(curl -s --max-time 1 "https://v2.jokeapi.dev/joke/programming?type=single&format=txt")
    fi
    [ -z "$JOKE" ] && JOKE="Hello World!"
    # Escape Quotes for C++ string
    echo "$JOKE" | sed 's/"/\\"/g'
}

create_class() {
    # Auto-Detect Language based on files
    local lang=""
    if [ -f "Makefile" ]; then
        if grep -q "cpp" Makefile; then lang="cpp"; fi
        if grep -q "gcc" Makefile; then lang="c"; fi
    elif [ -f "requirements.txt" ] || [ -f "venv" ]; then
        lang="python"
    fi

    # Fallback Selection
    if [ -z "$lang" ]; then
        ui_header "NEW CLASS" "Select Language"
        echo "  1) C++ (.cpp / .h)"
        echo "  2) C (.c / .h)"
        echo "  3) Python (.py)"
        printf "\n${C_ACCENT}Choice:${RESET} "
        read -r c
        case "$c" in
            1) lang="cpp" ;; 2) lang="c" ;; 3) lang="python" ;; *) return ;;
        esac
    fi

    ui_input "Class Name" "MyClass"
    CLASS_NAME="$VAL"
    [ -z "$CLASS_NAME" ] && return

    cursor_on
    if [ "$lang" == "cpp" ]; then
        mkdir -p src includes
        get_cpp_header "$CLASS_NAME" > "includes/$CLASS_NAME.h"
        get_cpp_source "$CLASS_NAME" > "src/$CLASS_NAME.cpp"
        printf "${C_SUCCESS}✔ Created src/$CLASS_NAME.cpp & includes/$CLASS_NAME.h${RESET}\n"
    
    elif [ "$lang" == "c" ]; then
        mkdir -p src includes
        # C Header
        UPPER=$(echo "$CLASS_NAME" | tr '[:lower:]' '[:upper:]')
        echo "#ifndef ${UPPER}_H" > "includes/$CLASS_NAME.h"
        echo "#define ${UPPER}_H" >> "includes/$CLASS_NAME.h"
        echo "" >> "includes/$CLASS_NAME.h"
        echo "// Function prototypes" >> "includes/$CLASS_NAME.h"
        echo "" >> "includes/$CLASS_NAME.h"
        echo "#endif" >> "includes/$CLASS_NAME.h"
        
        # C Source
        echo "#include \"../includes/$CLASS_NAME.h\"" > "src/$CLASS_NAME.c"
        printf "${C_SUCCESS}✔ Created src/$CLASS_NAME.c & includes/$CLASS_NAME.h${RESET}\n"

    elif [ "$lang" == "python" ]; then
        mkdir -p src
        echo "class $CLASS_NAME:" > "src/$CLASS_NAME.py"
        echo "    def __init__(self):" >> "src/$CLASS_NAME.py"
        echo "        pass" >> "src/$CLASS_NAME.py"
        printf "${C_SUCCESS}✔ Created src/$CLASS_NAME.py${RESET}\n"
    fi
    cursor_off
    sleep 1
}

create_project() {
    ui_header "PROJECT WIZARD" "New Project"
    echo "  1) C++ Project"
    echo "  2) C Project"
    echo "  3) Python Project"
    
    printf "\n${C_ACCENT}Choice:${RESET} "
    read -r c
    
    LANG=""
    case "$c" in
        1) LANG="cpp" ;; 2) LANG="c" ;; 3) LANG="python" ;; *) return ;;
    esac
    
    ui_input "Project Name" "my-project"
    PROJ_NAME="$VAL"
    [ -z "$PROJ_NAME" ] && return

    # Check Folder
    if [ -d "$PROJ_NAME" ]; then
        printf "\n${C_RED}Error: Folder '$PROJ_NAME' already exists.${RESET}\n"
        sleep 2; return
    fi

    cursor_on
    printf "\n${C_ACCENT}Scaffolding $PROJ_NAME...${RESET}\n"
    
    mkdir -p "$PROJ_NAME"
    cd "$PROJ_NAME" || exit 1
    
    # Common Setup
    git init -q
    echo "# $PROJ_NAME" > README.md
    echo "doc/" >> .gitignore
    echo ".DS_Store" >> .gitignore

    if [ "$LANG" == "cpp" ]; then
        mkdir -p src includes obj
        echo "obj/" >> .gitignore
        echo "$PROJ_NAME" >> .gitignore
        
        # Makefile
        get_makefile_content "$PROJ_NAME" "cpp" "c++" "-std=c++98" > Makefile
        
        # Main.cpp with Joke
        printf "${C_MUTED}Fetching joke...${RESET} "
        JOKE=$(fetch_joke)
        
        cat <<EOF > src/main.cpp
#include <iostream>

int main() {
    std::cout << "$JOKE" << std::endl;
    return 0;
}
EOF

    elif [ "$LANG" == "c" ]; then
        mkdir -p src includes obj
        echo "obj/" >> .gitignore
        echo "$PROJ_NAME" >> .gitignore
        
        # Makefile
        get_makefile_content "$PROJ_NAME" "c" "gcc" "" > Makefile
        
        # Main.c
        cat <<EOF > src/main.c
#include <stdio.h>
#include <unistd.h>

int main(void) {
    printf("Hello form C!\n");
    return 0;
}
EOF

    elif [ "$LANG" == "python" ]; then
        mkdir -p src tests
        echo "__pycache__/" >> .gitignore
        echo "venv/" >> .gitignore
        
        cat <<EOF > src/main.py
def main():
    print("Hello from Python!")

if __name__ == "__main__":
    main()
EOF
        # Venv creation hint
        printf "${C_MUTED}Tip: Run 'python3 -m venv venv' to setup env.${RESET}\n"
    fi

    # Finalize
    git add .
    git commit -m "feat: initial project structure" >/dev/null 2>&1
    
    printf "${C_SUCCESS}✔ Project created!${RESET}\n"
    printf "  cd $PROJ_NAME\n"
    
    # Offer Code Open
    if command -v code >/dev/null 2>&1; then
        printf "\n${C_ACCENT}Open in VS Code? [Y/n]${RESET} "
        read -r y
        [[ "$y" =~ ^[Yy]?$ ]] && code .
    fi
    
    exit 0
}

# --- DISPATCH ---
if [[ "$1" == "-c" || "$1" == "class" ]]; then
    create_class
    exit 0
fi

if [[ "$1" == "new" ]]; then
    create_project
    exit 0
fi

# Menu Mode
while true; do
    ui_header "PROJECT CREATOR" "Scaffolding Tool"
    echo "  ${C_ACCENT}1)${RESET} Create New Project"
    echo "  ${C_ACCENT}2)${RESET} Create Class / Component"
    echo "  ${C_ACCENT}q)${RESET} Quit"
    
    printf "\n${C_ACCENT}Select:${RESET} "
    read -rsn1 key
    case "$key" in
        1) create_project ;;
        2) create_class ;;
        q) exit 0 ;;
    esac
done