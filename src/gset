#!/bin/bash
source "$HOME/.local/bin/git-suite-lib.sh"

CONF_DIR="$HOME/.config/git-suite"
SETTINGS="$CONF_DIR/settings.conf"
THEME_CONF="$CONF_DIR/theme.conf"
ALIAS_CONF="$CONF_DIR/aliases.conf"
LOADER="$CONF_DIR/loader.sh"

# --- ACTIONS ---

change_editor() {
    ui_header "EDITOR SETUP" "Select Default"
    echo "  1) VS Code (code --wait)"
    echo "  2) Nano"
    echo "  3) Vim"
    echo "  4) Custom"
    
    printf "\n${C_ACCENT}Choice:${RESET} "
    read -r c
    
    VAL=""
    case "$c" in
        1) VAL="code --wait" ;;
        2) VAL="nano" ;;
        3) VAL="vim" ;;
        4) ui_input "Command" "vim"; VAL="$VAL" ;;
        *) return ;;
    esac
    
    # Save
    if grep -q "GIT_EDITOR" "$SETTINGS"; then
        # Replace (Mac/Linux compatible sed)
        sed -i.bak "s|^export GIT_EDITOR=.*|export GIT_EDITOR='$VAL'|" "$SETTINGS" && rm "$SETTINGS.bak"
    else
        echo "export GIT_EDITOR='$VAL'" >> "$SETTINGS"
    fi
    
    # Apply to Git global as well
    git config --global core.editor "$VAL"
    
    printf "${C_SUCCESS}✔ Editor set to: $VAL${RESET}\n"
    sleep 1
}

change_user() {
    CUR_NAME=$(git config --global user.name)
    CUR_EMAIL=$(git config --global user.email)
    
    ui_header "GIT IDENTITY" "Global Config"
    ui_input "Name" "$CUR_NAME"; NAME="$VAL"
    ui_input "Email" "$CUR_EMAIL"; EMAIL="$VAL"
    
    if [ -n "$NAME" ]; then git config --global user.name "$NAME"; fi
    if [ -n "$EMAIL" ]; then git config --global user.email "$EMAIL"; fi
    
    printf "${C_SUCCESS}✔ Updated.${RESET}\n"
    sleep 1
}

change_theme() {
    ui_header "THEME SELECTOR" "Look & Feel"
    echo "  1) Default (Blue/Cyan)"
    echo "  2) Cyberpunk (Magenta/Cyan)"
    echo "  3) Hacker (Green/Green)"
    echo "  4) Warm (Yellow/Red)"
    echo "  5) Monochrome (White/Gray)"
    
    printf "\n${C_ACCENT}Choice:${RESET} "
    read -r c
    
    case "$c" in
        1) B=4; T=6; S=2 ;; # Blue/Cyan
        2) B=5; T=6; S=5 ;; # Magenta/Cyan
        3) B=2; T=2; S=2 ;; # Green/Green
        4) B=3; T=1; S=3 ;; # Yellow/Red
        5) B=7; T=7; S=8 ;; # White/Gray
        *) return ;;
    esac
    
    cat <<EOF > "$THEME_CONF"
C_BORDER_IDX=$B
C_TITLE_IDX=$T
C_SEL_IDX=$S
C_TEXT_IDX=7
C_MUTED_IDX=8
UI_STYLE=rounded
UI_PROMPT=❯
EOF
    printf "${C_SUCCESS}✔ Theme applied. Restart tool to see changes.${RESET}\n"
    sleep 1
}

reload_aliases() {
    # Re-Generate Loader Script (Logic from Installer)
    echo "# GIT SUITE LOADER" > "$LOADER"
    echo "export PATH=\"$HOME/.local/bin:\$PATH\"" >> "$LOADER"
    [ -f "$SETTINGS" ] && echo "source \"$SETTINGS\"" >> "$LOADER"
    
    if [ -f "$ALIAS_CONF" ]; then
        while IFS='|' read -r short name cmd; do
            [[ "$short" =~ ^# || -z "$short" ]] && continue
            echo "unalias $short >/dev/null 2>&1" >> "$LOADER"
            echo "alias $short='$cmd'" >> "$LOADER"
        done < "$ALIAS_CONF"
    fi
    chmod +x "$LOADER"
    
    printf "${C_SUCCESS}✔ Aliases reloaded. Please run: source ~/.zshrc (or .bashrc)${RESET}\n"
    read -rsn1 -p "Press key..."
}

# --- MAIN LOOP ---
while true; do
    ui_header "SETTINGS" "Control Center"
    
    echo "  ${C_ACCENT}1)${RESET} Git User & Email"
    echo "  ${C_ACCENT}2)${RESET} Editor Configuration"
    echo "  ${C_ACCENT}3)${RESET} Color Theme"
    echo "  ${C_ACCENT}4)${RESET} Edit Aliases (Raw File)"
    echo "  ${C_ACCENT}5)${RESET} Repair/Reload Aliases"
    echo ""
    echo "  ${C_MUTED}q) Quit${RESET}"
    
    printf "\n${C_ACCENT}Select:${RESET} "
    read -rsn1 key
    
    case "$key" in
        1) change_user ;;
        2) change_editor ;;
        3) change_theme ;;
        4) 
            ${GIT_EDITOR:-nano} "$ALIAS_CONF" 
            reload_aliases
            ;;
        5) reload_aliases ;;
        q) exit 0 ;;
    esac
done