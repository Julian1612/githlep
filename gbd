#!/bin/bash
# ---------------------------------------------------------------------------------------
# GBD - GIT BRANCH DELETE
# ---------------------------------------------------------------------------------------

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo -e "\n\033[1mNAME\033[0m\n    gbd - Git Branch Delete Wizard\n"
    echo -e "\033[1mDESCRIPTION\033[0m\n    Select and delete local branches safely."
    echo -e "    - Excludes current branch and main/master from the list."
    echo -e "    - Requires confirmation (y/n) before deletion.\n"
    exit 0
fi

BOLD='\033[1m'; RESET='\033[0m'; GREEN='\033[32m'; RED='\033[31m'; WHITE='\033[37m'; GRAY='\033[90m'; CYAN='\033[36m'
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then echo -e "${RED}Error: Not a git repo.${RESET}"; exit 1; fi
CURRENT_BRANCH=$(git branch --show-current)
BRANCHES=(); while IFS= read -r line; do [[ -n "$line" ]] && BRANCHES+=("$line"); done < <(git branch --format='%(refname:short)' | grep -v "^$CURRENT_BRANCH$" | grep -v "^main$" | grep -v "^master$")
TOTAL=${#BRANCHES[@]}; if [ $TOTAL -eq 0 ]; then echo -e "${GRAY}No deletable branches found.${RESET}"; exit 0; fi
MAX_VISIBLE=10; SELECTED=0; VIEW_START=0; tput civis; cleanup() { tput cnorm; }; trap cleanup EXIT

while true; do
    if [ $SELECTED -lt $VIEW_START ]; then VIEW_START=$SELECTED; elif [ $SELECTED -ge $((VIEW_START + MAX_VISIBLE)) ]; then VIEW_START=$((SELECTED - MAX_VISIBLE + 1)); fi
    echo -ne "\r"; echo -e "${BOLD}${WHITE}DELETE BRANCH${RESET} ${GRAY}(${TOTAL} found)${RESET}\033[K"; echo -e "${GRAY}Current: ${CYAN}${CURRENT_BRANCH}${RESET}\033[K"; echo -e "${GRAY}----------------------------------------${RESET}\033[K"
    for (( i=0; i<MAX_VISIBLE; i++ )); do
        IDX=$((VIEW_START + i)); echo -ne "\033[K"
        if [ $IDX -ge $TOTAL ]; then echo -e ""; else
            if [ $IDX -eq $SELECTED ]; then echo -e "${RED}${BOLD}  > ${BRANCHES[$IDX]}${RESET}"; else echo -e "    ${BRANCHES[$IDX]}${RESET}"; fi
        fi
    done
    read -rsn1 key
    if [[ $key == $'\x1b' ]]; then read -rsn2 k2; case "$k2" in '[A') ((SELECTED--)); [ $SELECTED -lt 0 ] && SELECTED=$((TOTAL - 1));; '[B') ((SELECTED++)); [ $SELECTED -ge $TOTAL ] && SELECTED=0;; esac; elif [[ $key == "q" ]]; then LINES_TO_CLEAR=$((3 + MAX_VISIBLE)); tput cuu $LINES_TO_CLEAR; tput ed; exit 0; elif [[ $key == "" ]]; then break; fi
    LINES_TO_CLEAR=$((3 + MAX_VISIBLE)); tput cuu $LINES_TO_CLEAR
done
LINES_TO_CLEAR=$((3 + MAX_VISIBLE)); tput cuu $LINES_TO_CLEAR; tput ed; tput cnorm
BRANCH=${BRANCHES[$SELECTED]}
echo -ne "${BOLD}${RED}Delete '${WHITE}$BRANCH${RED}'? [y/N]${RESET} "; read -rsn1 confirm
if [[ "$confirm" =~ ^[Yy]$ ]]; then echo -ne "\r\033[K"; OUT=$(git branch -D "$BRANCH" 2>&1); if [ $? -eq 0 ]; then echo -e "${GREEN}✔ Deleted ${BOLD}$BRANCH${RESET}"; else echo -e "${RED}✖ Failed:${RESET}"; echo "$OUT"; fi
else echo -ne "\r\033[K"; fi
